 #/[include stealthburner_leds.cfg]
[include timelapse.cfg]

   
[board_pins ebb36_custom]
mcu: ebb36
aliases:
    STATUS_NEOPIXEL=PD3
 
[include hardware/lights/status_leds_effects.cfg]
[include hardware/lights/neopixel_caselight_effects.cfg]

[neopixel status_leds]
pin: ebb36:STATUS_NEOPIXEL
chain_count: 3
color_order: GRBW, GRBW, GRBW

# autotune incompatible with sensorless home on klipper
# [autotune_tmc stepper_x]
# motor: moons-ms17hd6p4200
# sg4_thrs: 255 # 70~125
# [autotune_tmc stepper_y]
# motor: moons-ms17hd6p4200
# sg4_thrs: 255  # 70~130
#
[autotune_tmc stepper_z]
motor: moons-ms17hd6p4200
[autotune_tmc stepper_z1]
motor: moons-ms17hd6p4200
[autotune_tmc stepper_z2]
motor: moons-ms17hd6p4200
[autotune_tmc stepper_z3]
motor: moons-ms17hd6p4200
# [autotune_tmc extruder]
# motor: ldo-36sth20-1004ahg-9T

[autotune_tmc extruder]
motor: moons-cse14hra1l410a

[manual_probe]

[filament_switch_sensor tool_start]
switch_pin:^!ebb36:PB5
# pause_on_runout: True 
# runout_gcode:
#     M117 Runout Detected!

[filament_switch_sensor tool_end]
switch_pin:^!ebb36:PB6
# pause_on_runout: True 
# runout_gcode:
#     M117 Runout Detected!
    
# [filament_motion_sensor SFS_T0]
# switch_pin: ^!PB10
# detection_length: 7.0
# extruder: extruder
# pause_on_runout: True 
# event_delay: 3.0
# pause_delay: 0.5
# runout_gcode:
#   M117 Runout Detected!


[input_shaper]
shaper_type_x: 3hump_ei 
shaper_freq_x: 81
damping_ratio_x: 0.075
shaper_type_y: mzv
shaper_freq_y: 39.0
damping_ratio_y: 0.067


#####################################################################
#   UUID Setting
#####################################################################
[mcu]
canbus_uuid: cc3bf50f96ab

[mcu ebb36]
canbus_uuid: dbda83543fe2

#[mcu sb2040]
#canbus_uuid: d3bdb09be729
##166965740477   2240
##7d1e80096a67   bad 2209

[printer]
kinematics: corexy
max_velocity: 320  
max_accel: 4500    			
max_z_velocity: 25 			
max_z_accel: 350
square_corner_velocity: 7.0



#####################################################################
# 	X/Y Stepper Settings
#####################################################################

## X Stepper on Motor1(B Motor)
[stepper_x]
step_pin: PE6
dir_pin: !PE5
enable_pin: !PC14
microsteps: 64
rotation_distance: 40
position_min: 0
position_endstop: 0
position_max: 350

# sensorless homing
endstop_pin: tmc2209_stepper_x:virtual_endstop
homing_speed: 20
homing_retract_dist: 0
homing_positive_dir: false

[tmc2209 stepper_x]
uart_pin: PC13
interpolate: true
run_current: 1.0
sense_resistor: 0.110

# sensorless homing
diag_pin: ^PF4
driver_SGTHRS: 40

## Y Stepper on Motor2 (A Motor)
[stepper_y]
step_pin: PE2
dir_pin: !PE1
enable_pin: !PE4
microsteps: 64
rotation_distance: 40
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: 0
position_endstop: 0
position_max: 350

##--------------------------------------------------------------------
homing_speed: 20
homing_retract_dist: 0
homing_positive_dir: false
#use_sensorless_homing: true

[tmc2209 stepper_y]
uart_pin: PE3
interpolate: true
run_current: 1.0
sense_resistor: 0.110
diag_pin: ^PF3
driver_SGTHRS: 40
#home_current: 0.8
#current_change_dwell_time: 0.2

#####################################################################
# 	Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left on MOTOR3
[stepper_z]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PE0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16
endstop_pin: probe:z_virtual_endstop
position_max: 330

##--------------------------------------------------------------------
position_min: -5
homing_speed: 6
second_homing_speed: 6
homing_retract_dist: 6

[tmc2209 stepper_z]
uart_pin: PB9
interpolate: True
run_current: 1.0
sense_resistor: 0.110

##	Z1 Stepper - Rear Left on Motor4
[stepper_z1]
step_pin: PB4
dir_pin: PB3
enable_pin: !PB6
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

[tmc2209 stepper_z1]
uart_pin: PB5
interpolate: True
run_current: 1.0
sense_resistor: 0.110 


##	Z2 Stepper - Rear Right on Motor5
[stepper_z2]
step_pin: PG13
dir_pin: !PG12
enable_pin: !PG15
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

[tmc2209 stepper_z2]
uart_pin: PG14
interpolate: True
run_current: 1.0
sense_resistor: 0.110 



##	Z3 Stepper - Front Right on Motor6
[stepper_z3]
step_pin: PG9
dir_pin: PD7
enable_pin: !PG11
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

[tmc2209 stepper_z3]
uart_pin: PG10
interpolate: True
run_current: 1.0
sense_resistor: 0.110 




[extruder]
step_pin: ebb36:PD0
dir_pin: ebb36:PD1 
enable_pin: !ebb36:PD2

#pid_Kp: 1
#pid_Ki: 1
#pid_Kd: 1
#control: pid

# # g2
# rotation_distance: 44.38044 # 47.088
# gear_ratio: 9:1

rotation_distance: 22.1715095
gear_ratio: 50:10

microsteps: 16

nozzle_diameter: 0.400
filament_diameter: 1.750
pressure_advance: 0.02
min_extrude_temp: 20
max_extrude_cross_section: 80
max_extrude_only_distance: 300

heater_pin: ebb36:PB13  
# sensor_type: PT1000
# pullup_resistor: 1000

sensor_type: Generic 3950
sensor_pin: ebb36: PA3

pwm_cycle_time: 0.02  # = 50Hz
smooth_time: 1.5
max_power: 1
min_temp: 0
max_temp: 330

# [tmc2240 extruder]
# cs_pin: sb2040:gpio11               # SPI 片选Pin脚定义
# spi_software_sclk_pin: sb2040:gpio0
# spi_software_mosi_pin: sb2040:gpio3
# spi_software_miso_pin: sb2040:gpio2
# interpolate: False
# rref: 12300                         # 驱动采样电阻
# run_current: 0.65
# stealthchop_threshold: 99999
# driver_TPFD: 0

[tmc2209 extruder]
uart_pin: ebb36: PA15
run_current: 0.6
stealthchop_threshold: 999999
sense_resistor: 0.110

[fan]
pin: ebb36:PA0
kick_start_time: 0.5

[heater_fan nevermore_fan]
#  Exhaust fan - Nevermore Filter
pin: PF6
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 5.0
heater: heater_bed
heater_temp: 68
fan_speed: 1.0 

[heater_fan hotend_fan]
pin: ebb36:PA1
# max_power: 1.0
# kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
##  If you are experiencing back flow, you can reduce fan_speed
#fan_speed: 1.0


[heater_bed]
heater_pin: PA1
min_temp: 0
max_temp: 120
pwm_cycle_time: 0.02  # = 50Hz
sensor_type: Generic 3950
sensor_pin: PB1
#pid_Kp: 1
#pid_Ki: 1
#pid_Kd: 1
#control: pid

[temperature_sensor buildplate]
sensor_type: Generic 3950
sensor_pin: PB0
min_temp: -40
max_temp: 120


[temperature_sensor chamber]
sensor_type: Generic 3950
sensor_pin: PC5
min_temp: -40
max_temp: 100

# [temperature_sensor SB2040]
# sensor_type: ATC Semitec 104GT-2
# sensor_pin: sb2040:gpio26

[temperature_sensor CB1]
sensor_type: temperature_host


[probe_eddy_ng probe]
sensor_type: btt_eddy
i2c_mcu: ebb36
i2c_bus: i2c3_PB3_PB4
x_offset: 0
y_offset: 25

#write_tap_plot: true
#write_every_tap_plot: true



# [output_pin _probe_ready]
# pin: sb2040:gpio29
# shutdown_value: 0
# value:0

# [probe]
# pin: ^sb2040:gpio28
# speed: 8
# samples: 5
# samples_result: median
# sample_retract_dist: 5
# samples_tolerance: 0.06
# samples_tolerance_retries: 12
# activate_gcode:
#     {% set PROBE_TEMP = 150 %}
#     {% set MAX_TEMP = PROBE_TEMP + 5 %}
#     {% set ACTUAL_TEMP = printer.extruder.temperature %}
#     {% set TARGET_TEMP = printer.extruder.target %}

#     {% if TARGET_TEMP > PROBE_TEMP %}
#         { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#         M106 S255 ; 100% the part cooling fan to help the extruder cooling
#         SET_HEATER_TEMPERATURE HEATER=extruder TARGET={ [ PROBE_TEMP, ACTUAL_TEMP ] | min }
#         TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#         M106 S0   ; Stop the part cooling fan
#     {% else %}
#         # Temperature target is already low enough, but nozzle may still be too hot.
#         {% if ACTUAL_TEMP > MAX_TEMP %}
#             { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#             M106 S255 ; 100% the part cooling fan to help the extruder cooling
#             TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#             M106 S0   ; Stop the part cooling fan
#         {% endif %}
#     {% endif %}
    
#     G4 P300
#     SET_PIN PIN=_probe_ready VALUE=1
#     G4 P300
# deactivate_gcode:
#     SET_PIN PIN=_probe_ready VALUE=0  

# [homing_override]
# gcode:
#     G28 Y
#     G28 X
#     G90
#     G0 X175 Y175 F3000 
#     G28 Z                      ; do the coarse home
#     G90                        ; set absolute positioning
#     G0 Z2 F1000                ; to 2mm -- home height (or whatever you'd like), for maximum sensor accuracy
#     G4 S1                      ; chill for a sec
#     M400                       ; wait for move to finish
#     PROBE_EDDY_NG_PROBE_STATIC HOME_Z=1 ; read the current exact height from sensor and home Z to it
#     M400
#     G0 Z5 F1000 ; to 5mm as home
# axes: z


# [safe_z_home]
# home_xy_position: 175,175
# speed: 80
# z_hop: 5


# Note you may need to add the following to your printer.cfg somewhere (without the comments of course) for the Kinematic position stuff below to work.
[force_move]
enable_force_move: True

[gcode_macro _HOME_X]
gcode:
    # Home
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    
    {% set RETRACT_CURRENT = 0.25 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RETRACT_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RETRACT_CURRENT}
    
    SET_KINEMATIC_POSITION X=15 SET_HOMED=X
    G91
    G1 X30 F1200
    
    {% set HOME_CURRENT = 0.8 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    #SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    
    G4 P2000
    #M400 to finish all pending moves/process the buffer
    M400 
    # Home again
    G28 X
    
    # Move away
    G91
    G1 X30 F1200
    G28 X
    
    # Move away
    G91
    G1 X30 F1200
    
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

[gcode_macro _HOME_Y]
gcode:
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    
    {% set RETRACT_CURRENT = 0.25 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RETRACT_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RETRACT_CURRENT}
    
    SET_KINEMATIC_POSITION Y=15 SET_HOMED=Y
    G91
    G1 Y30 F1200
    
    {% set HOME_CURRENT = 0.8 %}
    #SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    G4 P2000
    #M400 to finish all pending moves/process the buffer
    M400 
    
    # Home
    G28 Y
    # Move away
    G91
    G1 Y30 F1200
    # Home again
    G28 Y
    # Move away
    G91
    G1 Y30 F1200
    
    # Wait just a second… (give StallGuard registers time to clear)
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

[homing_override]
axes: xyz
gcode:
  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}

  SET_KINEMATIC_POSITION Z=1 SET_HOMED=Z
  G1 Z4 F1200

  {% if home_all or 'Y' in params %}
    _HOME_Y
  {% endif %}
  
  {% if home_all or 'X' in params %}
    _HOME_X
  {% endif %}
  
  {% if home_all or 'Z' in params %}

    G90
    G1 X175 Y175 F15000

    G28 Z

    G1 Z10 F1500
  {% endif %}

[multi_pin controller_fans]
pins: PF7,PF9

[controller_fan controller_fan]
##  Controller fan
pin: multi_pin:controller_fans
max_power: 0.55
kick_start_time: 0.5
heater: heater_bed
idle_speed: 0.1
idle_timeout: 120

[quad_gantry_level]
gantry_corners:
	-50,0
	395,430
points:
	80,70
	80,230
	270,230
	270,70
speed: 60
horizontal_move_z: 2
retries: 15
retry_tolerance: 0.01
max_adjust: 20
    
[bed_mesh]
speed: 60
horizontal_move_z: 2
mesh_min: 70,70
mesh_max: 280,280
probe_count: 11,11
algorithm: bicubic
fade_start: 1
fade_end: 5


[adxl345]
cs_pin: ebb36: PB12
spi_bus: spi2_PB2_PB11_PB10
axes_map: x, z, -y

[resonance_tester]
probe_points:
  175, 175, 20
accel_chip: adxl345
accel_per_hz: 90

# [display]
# #	mini12864 LCD Display
# lcd_type: uc1701
# cs_pin: EXP1_3
# a0_pin: EXP1_4
# rst_pin: EXP1_5
# encoder_pins: ^EXP2_5, ^EXP2_3
# click_pin: ^!EXP1_2
# contrast: 63
# spi_software_miso_pin: EXP2_1
# spi_software_mosi_pin: EXP2_6
# spi_software_sclk_pin: EXP2_2

# [neopixel btt_mini12864]
# #	To control Neopixel RGB in mini12864 display
# pin: EXP1_6
# chain_count: 3
# initial_RED: 0.1
# initial_GREEN: 0.5
# initial_BLUE: 0.0
# color_order: RGB

# ##	Set RGB values on boot up for each Neopixel. 
# ##	Index 1 = display, Index 2 and 3 = Knob
# [delayed_gcode setdisplayneopixel]
# initial_duration: 1
# gcode:
#        SET_LED LED=btt_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
#        SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
#        SET_LED LED=btt_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3 

[delayed_gcode _Dada_INIT_LEDS]
initial_duration: 1
gcode:
    STATUS_LEDS COLOR="READY"

[delayed_gcode _filament_sensor_off]
initial_duration: 1
gcode:
  ;SET_FILAMENT_SENSOR SENSOR=SFS_T0 ENABLE=0

#################################################
################### Disco Led ###################
#################################################
[neopixel caselight]
pin: PD15
chain_count: 50
color_order: GRB
initial_RED: 0.1
initial_GREEN: 0.1
initial_BLUE: 0.1

# [pwm_cycle_time  _BEEPER_pin]
# pin: EXP1_1
# value: 0
# shutdown_value: 0
# cycle_time: 0.001
# #scale: 1000

# [gcode_macro start_tones]
# gcode: # A-D-A-E
#     { action_respond_info('start_tones') }
#     M300 S440  P220
#     M300 S587  P220
#     M300 S880  P220
#     M300 S1318  P220 

# [gcode_macro end_tones]
# gcode: # A-C-E-G
#     { action_respond_info('end_tones') }
#     M300 S880 P220
#     M300 S523 P220
#     M300 S329 P220
#     M300 S196 P220
    
[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE7, EXP1_2=PG1,
    EXP1_3=PG0, EXP1_4=PF15,
    EXP1_5=PF14, EXP1_6=PF13,    # Slot in the socket on this side
    EXP1_7=PF12, EXP1_8=PF11,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PE13, EXP2_2=PE12,
    EXP2_3=PE15, EXP2_4=PE11,
    EXP2_5=PE10, EXP2_6=PE14,      # Slot in the socket on this side
    EXP2_7=PE8, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<NC>,

    # Klippain
    LIGHT_NEOPIXEL=PD15,



# Enable object exclusion
[exclude_object]

# Enable arcs support
[gcode_arcs]
resolution: 0.1

[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
# number_of_results_to_keep: 3
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
# keep_raw_csv: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
# timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.


#####################################################################
#   Macros
#####################################################################
[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G90
    G28
    QUAD_GANTRY_LEVEL
    G28
    PARK
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro STATUS_HOMING]
gcode:
   STATUS_LEDS COLOR="HOMING"

   
[gcode_macro STATUS_leveling]
gcode:
   STATUS_LEDS COLOR="leveling"
   
[gcode_macro STATUS_heating]
gcode:
   STATUS_LEDS COLOR="heating"
   
   
[gcode_macro STATUS_cleaning]
gcode:
   STATUS_LEDS COLOR="cleaning"
   
[gcode_macro STATUS_ready]
gcode:
   STATUS_LEDS COLOR="ready"
   
[gcode_macro STATUS_busy]
gcode:
   STATUS_LEDS COLOR="busy"

[gcode_macro STATUS_meshing]
gcode:
   STATUS_LEDS COLOR="meshing"

[gcode_macro STATUS_printing]
gcode:
   STATUS_LEDS COLOR="printing"

[gcode_macro STATUS_done_printing]
gcode:
   STATUS_LEDS COLOR="done_printing"

   
# https://github.com/jontek2/A-better-print_start-macro
[gcode_macro PRINT_START]
gcode:
  # This part fetches data from your slicer. Such as bed, extruder, and chamber temps and size of your printer.
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set target_chamber = params.CHAMBER|default("45")|int %}
  {% set target_chamber_minimal = params.CHAMBER_MINIMAL|default("0")|int %}
  {% set target_chamber_wait = [target_chamber, target_chamber_minimal]|select(">", 0)|min|default(0) %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  ##  Uncomment for Beacon Contact (1 of 4 for beacon contact)
  ##SET_GCODE_OFFSET Z=0                                  # Set offset to 0

  # Clear any lingering pause states
  CLEAR_PAUSE

  # Home the printer, set absolute positioning and update the Stealthburner LEDs.
  STATUS_HOMING                                         # Set LEDs to homing-mode
  G28                                                   # Full home (XYZ)
  G90                                                   # Absolute position

  ##  Uncomment for bed mesh (1 of 2 for bed mesh)
  BED_MESH_CLEAR                                        # Clear old saved bed mesh (if any)

  # Check if the bed temp is higher than 90c - if so then trigger a heatsoak.
  {% if params.BED|int > 90 %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
    STATUS_HEATING                                      # Set LEDs to heating-mode
    M106 S255                                           # Turn on the PT-fan

    ##  Uncomment if you have a Nevermore.
    #SET_PIN PIN=nevermore VALUE=1                      # Turn on the nevermore

    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
    M190 S{target_bed}                                  # Set the target temp for the bed
    SET_DISPLAY_TEXT MSG="Soak for 5 min"               # Display info on display
    G4 P300000                                          # Wait 1 min for the bedtemp to stabilize
    SET_DISPLAY_TEXT MSG="Heatsoak: {target_chamber_wait}c"  # Display info on display
    TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber_wait}   # Waits for chamber temp

  # If the bed temp is not over 90c, then skip the heatsoak and just heat up to set temp with a 1 min soak
  {% else %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
    STATUS_HEATING                                      # Set LEDs to heating-mode
    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
    M190 S{target_bed}                                  # Set the target temp for the bed
    SET_DISPLAY_TEXT MSG="Soak for 1 min"               # Display info on display
    G4 P60000                                           # Wait 1 min for the bedtemp to stabilize
  {% endif %}

  # Heat hotend to 150c. This helps with getting a correct Z-home.
  SET_DISPLAY_TEXT MSG="Hotend: 150c"                   # Display info on display
  M109 S150                                             # Heat hotend to 150c

  ##  Uncomment for Beacon contact (2 of 4 for beacon contact)
  CLEAN_NOZZLE
  G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
  M190 S0
  M400
  PROBE_EDDY_NG_TAP START_Z=2.1                         # Calibrate z offset and beacon model
  M190 S{target_bed}

  ##  Uncomment for Trident (Z_TILT_ADJUST)
  #SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
  #STATUS_LEVELING                                      # Set LEDs to leveling-mode
  #Z_TILT_ADJUST                                        # Level the printer via Z_TILT_ADJUST
  #G28 Z                                                # Home Z again after Z_TILT_ADJUST

  ##  Uncomment for V2.4 (Quad gantry level AKA QGL)
  SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
  STATUS_LEVELING                                      # Set LEDs to leveling-mode
  M190 S0
  M400
  QUAD_GANTRY_LEVEL                                    # Level the printer via QGL
  M190 S{target_bed}
  G28 Z                                                # Home Z again after QGL

  ##  Uncomment for bed mesh (2 of 2 for bed mesh)
  SET_DISPLAY_TEXT MSG="Bed mesh"                      # Display info on display
  STATUS_MESHING                                       # Set LEDs to bed mesh-mode
  M190 S0
  M400
  BED_MESH_CALIBRATE METHOD=rapid_scan                 # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh
  M190 S{target_bed}

  ## Uncomment for Beacon Contact (3 of 4 for beacon contact)
  CLEAN_NOZZLE
  G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
  M190 S0
  M400
  PROBE_EDDY_NG_TAP START_Z=2.1                         # Calibrate z offset only with hot nozzle
  M190 S{target_bed}

  # Heat up the hotend up to target via data from slicer
  SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"     # Display info on display
  STATUS_HEATING                                        # Set LEDs to heating-mode
  G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
  M107                                                  # Turn off partcooling fan
  M109 S{target_extruder}                               # Heat the hotend to set temp

  ##   Uncomment for Beacon Contact (4 of 4 for beacon contact)
  ### SET_GCODE_OFFSET Z=0.06                               # Add a little offset for hotend thermal expansion

  # Get ready to print by doing a primeline and updating the LEDs
  SET_DISPLAY_TEXT MSG="Printer goes brr"               # Display info on display
  STATUS_PRINTING                                       # Set LEDs to printing-mode
  G0 X{x_wait - 50} Y4 F10000                           # Go to starting point
  G0 Z0.4                                               # Raise Z to 0.4
  G91                                                   # Incremental positioning 
  G1 X100 E20 F1000                                     # Primeline
  G90                                                   # Absolute position


[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    
    G91                            ; relative positioning
    G1 Z10 F1000
    G0 Z-1.00 X20.0 Y20.0 F2000    ; move nozzle to remove stringing
    
    TURN_OFF_HEATERS
    
    M107                           ; turn off fan
    BED_MESH_CLEAR
    SET_DISPLAY_TEXT MSG=""
    M18
    ;SET_FILAMENT_SENSOR SENSOR=SFS_T0 ENABLE=0

[gcode_macro END_PRINT]
gcode:
    PRINT_END

[gcode_macro PAUSE]
gcode:
    PARK


[gcode_macro CLEAN_NOZZLE]
gcode:
    { action_respond_info('CLEAN_NOZZLE') }
    M400
    {% if (printer.toolhead.homed_axes == 'xyz') %}
    SAVE_GCODE_STATE NAME=_CLEAN_NOZZLE_STATE

    STATUS_cleaning

    G91
    G0 Z5
    
    G90
    G0 X70 Y345 F4000
    G0 Z0.8
    G0 X140 Y330 F2000
    G0 X130 Y345 F2000
    G0 X120 Y330 F2000
    G0 X110 Y345 F2000
    G0 X100 Y330 F2000
    G0 X90  Y345 F2000
    G0 X80  Y330 F2000
    G0 X70  Y345 F1500

    G0 X80  Y330 F2000
    G0 X90  Y345 F2000
    G0 X100 Y330 F2000
    G0 X110 Y345 F2000
    G0 X120 Y330 F2000
    G0 X130 Y345 F2000
    G0 X140 Y330 F2000
    
    G0 Z30

    STATUS_READY
    
    RESTORE_GCODE_STATE NAME=_CLEAN_NOZZLE_STATE MOVE=1
    {% else %}
    { action_respond_info('CLEAN_NOZZLE: NOT HOMED') }
    {% endif %}
    { action_respond_info('CLEAN_NOZZLE: H') }


[idle_timeout]
timeout: 1800
gcode:
    RESPOND MSG="Idle timeout reached"
    TURN_OFF_HEATERS
    M84
    {% if printer["gcode_macro _USER_VARIABLES"].light_enabled %}
        LIGHT_OFF
    {% endif %}
    {% if printer["gcode_macro _USER_VARIABLES"].status_leds_enabled %}
        STATUS_LEDS COLOR="OFF"
    {% endif %}
    

[pause_resume]

[respond]

[save_variables]
filename: ~/printer_data/config/variables.cfg 

[virtual_sdcard]
path: ~/printer_data/gcodes

[display_status]


[gcode_macro AFTER_LAYER_CHANGE]
gcode:
    M400

[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos   : True ; use custom park coordinates for x,y [True/False]
variable_custom_park_x    : 20.0   ; custom x position; value must be within your defined min and max of X
variable_custom_park_y    : 330.0  ; custom y position; value must be within your defined min and max of Y
variable_custom_park_dz   : 10.0   ; custom dz value; the value in mm to lift the nozzle when move to park position
variable_retract          : 1.0   ; the value to retract while PAUSE
variable_cancel_retract   : 1.0   ; the value to retract while CANCEL_PRINT
variable_speed_retract    : 10.0  ; retract speed in mm/s
variable_unretract        : 1.0   ; the value to unretract while RESUME
#variable_speed_unretract  : 35.0  ; unretract speed in mm/s
#variable_speed_hop        : 15.0  ; z move speed in mm/s
#variable_speed_move       : 100.0 ; move speed in mm/s
variable_park_at_cancel   : True ; allow to move the toolhead to park while execute CANCEL_PRINT [True/False]
variable_park_at_cancel_x : 20     ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
variable_park_at_cancel_y : 330    ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
## !!! Caution [firmware_retraction] must be defined in the printer.cfg if you set use_fw_retract: True !!!
#variable_use_fw_retract   : False ; use fw_retraction instead of the manual version [True/False]
variable_idle_timeout     : 1800  ; time in sec until idle_timeout kicks in. Value 0 means that no value will be set or restored
#variable_runout_sensor    : ""    ; If a sensor is defined, it will be used to cancel the execution of RESUME in case no filament is detected.
##                                   Specify the config name of the runout sensor e.g "filament_switch_sensor runout". Hint use the same as in your printer.cfg
## !!! Custom macros, please use with care and review the section of the corresponding macro.
## These macros are for simple operations like setting a status LED. Please make sure your macro does not interfere with the basic macro functions.
## Only  single line commands are supported, please create a macro if you need more than one command.
#variable_user_pause_macro : ""    ; Everything inside the "" will be executed after the klipper base pause (PAUSE_BASE) function
#variable_user_resume_macro: ""    ; Everything inside the "" will be executed before the klipper base resume (RESUME_BASE) function
#variable_user_cancel_macro: ""    ; Everything inside the "" will be executed before the klipper base cancel (CANCEL_PRINT_BASE) function
gcode:

[include mainsail.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 48.019
#*# pid_ki = 0.953
#*# pid_kd = 605.033
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 20.760
#*# pid_ki = 1.225
#*# pid_kd = 87.971
#*#
#*# [probe_eddy_ng probe]
#*# calibrated_drive_currents = 16, 17
#*# calibration_version = 5
#*# reg_drive_current = 16
#*# tap_drive_current = 17
#*# calibration_16 = gASVygMAAAAAAAB9lCiMAXaUSwWMBGZ0b2iUjBtudW1weS5wb2x5bm9taWFsLnBvbHlub21pYWyUjApQb2x5bm9taWFslJOUKYGUfZQojARjb2VmlIwVbnVtcHkuY29yZS5tdWx0aWFycmF5lIwMX3JlY29uc3RydWN0lJOUjAVudW1weZSMB25kYXJyYXmUk5RLAIWUQwFilIeUUpQoSwFLCoWUaAyMBWR0eXBllJOUjAJmOJSJiIeUUpQoSwOMATyUTk5OSv////9K/////0sAdJRiiUNQ0HZwrYv69j/5NlObZbD7P06ODef0qeY/nfTwBMZY4z8AH8zj+UjUP1Z15BT+Ydq/rwy5ShEMur/ewjUBOWjnP3S3BWY6EMo/G77worTsyr+UdJRijAZkb21haW6UaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxCJ2BksimuUPhgMhucq8pQ+lHSUYowGd2luZG93lGgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQAAAAAAAA8L8AAAAAAADwP5R0lGKMB19zeW1ib2yUjAF4lIwGc3ltYm9slGgsdWKMCWZ0b2hfaGlnaJRoBSmBlH2UKGgIaAtoDksAhZRoEIeUUpQoSwFLCoWUaBiJQ1AGhKCrkTsaQCaP59+mRwhAcAX8OLyI+j8+WrJPlbvwP+LNpr8uf+M/0w4/R7vd4j+5w1qT4WXPP+6ZZHVX+Fc/h3Iz6d7g5j+y8qW/AiXjP5R0lGJoHWgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQ4owW89jtlD5FfTT/LwmVPpR0lGJoJGgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQAAAAAAAA8L8AAAAAAADwP5R0lGJoK2gsaC1oLHVijARodG9mlGgFKYGUfZQoaAhoC2gOSwCFlGgQh5RSlChLAUsKhZRoGIlDUFX23J1l0JQ+qGTSaORyKz781MBhgjAfvtMN4w0a4RA+Y2reLgZ+8r1WYjI+bBIFvpFvjoKtssU9XjX4IqvCBz6NG/cMhOPZPZJRk2z5kfe9lHSUYmgdaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxCA7RRC64K+P7aWI+Vt/xNAlHSUYmgkaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxAAAAAAAADwvwAAAAAAAPA/lHSUYmgraCxoLWgsdWKMB2hfcmFuZ2WUXZQoRz++gutCFO2AR0At/xnznxtNZYwHZl9yYW5nZZRdlChHQUhW4BdDOABHQUkSx+Z1OABljAJkY5RLEHUu
#*# calibration_17 = gASV6QIAAAAAAAB9lCiMAXaUSwWMBGZ0b2iUjBtudW1weS5wb2x5bm9taWFsLnBvbHlub21pYWyUjApQb2x5bm9taWFslJOUKYGUfZQojARjb2VmlIwVbnVtcHkuY29yZS5tdWx0aWFycmF5lIwMX3JlY29uc3RydWN0lJOUjAVudW1weZSMB25kYXJyYXmUk5RLAIWUQwFilIeUUpQoSwFLCoWUaAyMBWR0eXBllJOUjAJmOJSJiIeUUpQoSwOMATyUTk5OSv////9K/////0sAdJRiiUNQ9Y5FYUro7z+N2AzoImv0PzE0UiNURds/lgL5Ey/4yD9gg+C2GOGHP4TqIBM/O5w/irmO5+s5xD/eJbebuhylP6aNj6YU86+/HwGVJE5yib+UdJRijAZkb21haW6UaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxAeYwRlvHOUPgs7YlWf+pQ+lHSUYowGd2luZG93lGgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQAAAAAAAA8L8AAAAAAADwP5R0lGKMB19zeW1ib2yUjAF4lIwGc3ltYm9slGgsdWKMCWZ0b2hfaGlnaJROjARodG9mlGgFKYGUfZQoaAhoC2gOSwCFlGgQh5RSlChLAUsKhZRoGIlDUPr9xvrLz5Q+XRHDID+7Lj4F1fpGvwAYvnmFuhIQh/09XxTMIPIt3b2aS0IKap3uvbjILaR5jt09ziAQKUT08D0Se5CkQGbIvTKG4IaTzdq9lHSUYmgdaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxAAykx0Jm4tP2yHSh1XeQhAlHSUYmgkaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxAAAAAAAADwvwAAAAAAAPA/lHSUYmgraCxoLWgsdWKMB2hfcmFuZ2WUXZQoRz8tbiZ0TMoAR0AIeVcdSodsZYwHZl9yYW5nZZRdlChHQUhnxgCU6ABHQUkIu5KHGABljAJkY5RLEXUu
